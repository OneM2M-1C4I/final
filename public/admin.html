<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administrator Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }

      h1 {
        margin: 10px 0;
        font-size: 2em;
        color: black;
        text-align: center;
      }

      .main-container {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: flex-start;
        padding: 20px;
        box-sizing: border-box;
        width: 100%;
        height: auto;
      }

      .seat-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        width: 40%;
        margin-left: 200px;
        margin-right: 120px;
        margin-top: 50px;
      }

      .seat-title {
        text-align: center;
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .seat-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 15px;
      }

      .seat-box {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid black;
        border-radius: 7px;
        font-size: 14px;
        font-weight: bold;
        color: white;
      }

      .seat-active {
        background-color: green;
      }

      .seat-inactive {
        background-color: red;
      }

      .chart-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        width: 60%;
        max-width: 700px;
        margin-left: 10px;
        margin-top: 50px;
      }

      .chart-title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
      }

      canvas {
        width: 100% !important;
        max-width: 600px;
        height: auto !important;
        max-height: 300px;
      }

      .chart-buttons {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .chart-buttons button {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        justify-content: center;
      }

      .chart-buttons button:hover {
        color: blue;
      }
    </style>
  </head>
  <body>
    <h1>Administrator Page</h1>
    <div class="main-container">
      <div class="seat-container">
        <div class="seat-title">Seat Occupation</div>
        <div class="seat-grid" id="seatGrid"></div>
      </div>
      <div class="chart-container">
        <div class="chart-title">Data of Posture</div>
        <canvas id="postureChart"></canvas>
        <div class="chart-buttons">
          <button onclick="showPrevious()">&#8592;</button>
          <button onclick="showNext()">&#8594;</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const seatGrid = document.getElementById("seatGrid");
      const seatCount = 21;
      const seatStates = Array(seatCount).fill(false);

      // 초기 렌더링
      function renderSeatGrid() {
        seatGrid.innerHTML = "";
        for (let i = 0; i < seatCount; i++) {
          const seat = document.createElement("div");
          seat.className = `seat-box ${
            seatStates[i] ? "seat-active" : "seat-inactive"
          }`;
          seat.textContent = i + 1;
          seatGrid.appendChild(seat);
        }
      }

      // 활성화된 AE 상태 가져오기
      function fetchActiveAEs() {
        fetch("/admin/aes")
          .then((response) => response.json())
          .then((data) => {
            for (let i = 0; i < seatCount; i++) {
              seatStates[i] = data[`Seat${i + 1}`] || false;
            }
            renderSeatGrid();
          })
          .catch((error) =>
            console.error("Failed to fetch active AEs:", error)
          );
      }

      // 자세 데이터 차트 설정
      const postureChartCtx = document
        .getElementById("postureChart")
        .getContext("2d");
      let currentChartIndex = 0;

      const postureChart = new Chart(postureChartCtx, {
        type: "bar",
        data: {
          labels: Array.from({ length: 7 }, (_, i) => `Seat ${i + 1}`),
          datasets: [
            {
              label: "Posture Score",
              data: Array(7).fill(0),
              backgroundColor: "blue",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
            },
          },
        },
      });

      function updatePostureChart() {
        const start = currentChartIndex * 7;
        const end = start + 7;
        postureChart.data.labels = Array.from(
          { length: 7 },
          (_, i) => `Seat ${start + i + 1}`
        );
        postureChart.data.datasets[0].data = seatStates
          .slice(start, end)
          .map((state) => (state ? Math.random() * 10 : 0));
        postureChart.update();
      }

      function showPrevious() {
        if (currentChartIndex > 0) {
          currentChartIndex--;
          updatePostureChart();
        }
      }

      function showNext() {
        if ((currentChartIndex + 1) * 7 < seatCount) {
          currentChartIndex++;
          updatePostureChart();
        }
      }

      // 초기화 및 주기적 업데이트
      renderSeatGrid();
      updatePostureChart();
      fetchActiveAEs();
      setInterval(fetchActiveAEs, 3000);
    </script>
  </body>
</html>
