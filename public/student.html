<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Student Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        display: flex;
        flex-direction: column;
      }

      h1 {
        margin-top: 20px;
        font-size: 2em;
        color: black;
        text-align: center;
      }

      .main-container {
        display: flex;
        width: 100%;
        height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      .seat-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 66%;
        padding-right: 20px;
        box-sizing: border-box;
      }

      .choose-seat {
        text-align: center;
        font-size: 1.5em;
        color: black;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 20px;
        width: 100%;
      }

      .seat-card {
        background: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        text-align: center;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .seat-card img {
        width: 50px;
        height: 50px;
        margin-bottom: 10px;
      }

      .seat-card button {
        background-color: blue;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
      }

      .seat-card button:hover {
        background-color: darkblue;
      }

      .sub-devices {
        margin-top: 10px;
        width: 100%;
        text-align: center;
        display: none;
      }

      .sub-device {
        margin: 15px 0;
        text-align: center;
      }

      .sub-device img {
        width: 30px;
        height: 30px;
        margin-bottom: 5px;
      }

      .sub-device-text {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .sub-device button {
        margin: 5px;
        padding: 5px 10px;
        background-color: blue;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .sub-device button:hover {
        background-color: darkblue;
      }

      .feedback-container {
        width: 33%;
        background: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: flex-start;
      }

      .feedback-title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
        width: 100%;
      }

      .feedback-content {
        flex: 1;
        width: 100%;
        border: 1px solid black;
        border-radius: 5px;
        padding: 10px;
        box-sizing: border-box;
        background-color: #f9f9f9;
        overflow-y: auto;
      }

      .camera-button {
        background-color: blue;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 10px;
      }

      .emergency-button {
        background-color: red;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      .emergency-button:hover {
        background-color: darkred;
      }
  </style>
</head>
<body>
  <h1>Student Page</h1>
  
  <div class="main-container">
    <div class="seat-container">
      <div class="choose-seat">Choose your seat</div>
      <div class="grid-container" id="seatContainer">
        <!-- JavaScript로 좌석 생성 -->
      </div>
    </div>

    <div class="feedback-container">
      <div class="feedback-title">User Action Test</div>
      <div class="feedback-content">
		<h3>Selected User : <span id="selectedUser">None</span></h3>
		<textarea id="feedbackContent" style="width: 100%; height: 200px;"></textarea>

        <h3>Pose Camera</h3>
        <div style="text-align: center;">
          <div id="webcam-container"></div>
          <button class="camera-button" type="button" onclick="init()">Camera on</button>
        </div>
        <h3>Pose Alert</h3>
        <div id="label-container"></div>
        <div id="feedback">LED Lamp: <span id="led-indicator" class="led-indicator"></span></div>
        
        <h3>Light</h3>
        <div id="light-status">Light: <span id="light-indicator" class="led-indicator"></span></div>

        <h3>Emergency Button</h3>
        <button class="emergency-button" onclick="sendEmergencyAlert()">
          <img src="/images/icon-warning.png" alt="Emergency Icon" style="width: 20px; height: 20px;">
          Emergency button
        </button>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  

    <script>
		const seatContainer = document.getElementById("seatContainer");
		const feedbackContent = document.getElementById("feedbackContent");
		const seats = 21;

		let selectedUser = document.getElementById('selectedUser');
		let model, webcam, labelContainer, maxPredictions;

		async function init() {
			const modelURL = URL + "model.json";
			const metadataURL = URL + "metadata.json";

			model = await tmImage.load(modelURL, metadataURL);
			maxPredictions = model.getTotalClasses();

			const flip = true;
			webcam = new tmImage.Webcam(200, 200, flip);
			await webcam.setup();
			await webcam.play();
			window.requestAnimationFrame(loop);

			document.getElementById("webcam-container").appendChild(webcam.canvas);
			labelContainer = document.getElementById("label-container");
			for (let i = 0; i < maxPredictions; i++) {
				labelContainer.appendChild(document.createElement("div"));
			}
		}

		async function loop() {
			webcam.update();
			await predict();
			window.requestAnimationFrame(loop);
		}

		async function predict() {
			const prediction = await model.predict(webcam.canvas);
			let label = ["올바른 자세", "나쁜 자세"];
			for (let i = 0; i < maxPredictions; i++) {
				const classPrediction = label[i] + ": " + prediction[i].probability.toFixed(2);
				labelContainer.childNodes[i].innerHTML = classPrediction;
				if (i == 0 && prediction[i].probability.toFixed(2) < 0.5) {
					document.getElementById("led-indicator").innerHTML = "Off";
				} else if (i == 1 && prediction[i].probability.toFixed(2) > 0.5) {
					document.getElementById("led-indicator").innerHTML = "On";
				}
			}
		}

		for (let i = 1; i <= seats; i++) {
			const seatDiv = document.createElement("div");
			seatDiv.className = "seat-card";
			seatDiv.innerHTML = ` 
			<img src="/images/icon-seat.png" alt="Seat Icon">
			<p>Seat ${i}</p>
			<button onclick="activateSeat(${i})">Activate Seat</button>
			<button onclick="deactivateSeat(${i})">Deactivate Seat</button> <!-- 비활성화 버튼 추가 -->
			<div class="sub-devices" id="subDevices${i}">
			<div class="sub-device">
				<img src="/images/icon-camera.png" alt="Camera Icon">
				<div class="sub-device-text">Camera</div>
				<button onclick="toggleSubDevice(${i}, 'Camera', 'on')">On</button>
				<button onclick="toggleSubDevice(${i}, 'Camera', 'off')">Off</button>
			</div>
			<div class="sub-device">
				<img src="/images/icon-light.png" alt="Light Icon">
				<div class="sub-device-text">Light</div>
				<button onclick="toggleSubDevice(${i}, 'Light', 'on')">On</button>
				<button onclick="toggleSubDevice(${i}, 'Light', 'off')">Off</button>
			</div>
			<div class="sub-device">
				<img src="/images/icon-led.png" alt="LED Icon">
				<div class="sub-device-text">LED</div>
				<button onclick="toggleSubDevice(${i}, 'LED', 'on')">On</button>
				<button onclick="toggleSubDevice(${i}, 'LED', 'off')">Off</button>
			</div>
			</div>`;
			seatContainer.appendChild(seatDiv);
		}

		// 좌석 활성화 및 하위 디바이스 표시
		function activateSeat(seatNumber) {

			selectedUser.innerText = `Seat ${seatNumber}`;

			const subDevices = document.getElementById(`subDevices${seatNumber}`);
			subDevices.style.display =
			subDevices.style.display === "none" || !subDevices.style.display
				? "block"
				: "none";

			// 피드백 내용 업데이트
			feedbackContent.innerHTML += `Seat ${seatNumber} AE세트 생성 요청\n`;

			// 서버로 좌석 활성화 상태 전송
			fetch(`/devices/Seat${seatNumber}?type=seat`, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
			})
			.then((response) => {
				if (!response.ok) throw new Error("Failed to update seat status");
				console.log(`Seat ${seatNumber} AE created successfully.`);
				feedbackContent.innerHTML += `Seat ${seatNumber} AE세트 생성 성공\n`;
			})
			.catch((error) => {
				console.error(error)
				feedbackContent.innerHTML += `Seat ${seatNumber} AE세트 생성 실패\n`;
			});
		}

		// 좌석 비활성화 및 상태 갱신
		function deactivateSeat(seatNumber) {
			const subDevices = document.getElementById(`subDevices${seatNumber}`);
			subDevices.style.display = "none"; // 하위 디바이스 숨기기

			feedbackContent.innerHTML += `Seat ${seatNumber} AE세트 삭제 요청\n`;
			// 서버로 좌석 비활성화 상태 전송 (좌석 삭제와 함께)
			fetch(`/devices/Seat${seatNumber}/deactivate`, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
			})
			.then((response) => {
				if (!response.ok)
				throw new Error("Failed to deactivate and delete seat");
				console.log(
					`Seat ${seatNumber} deactivated and deleted successfully.`
				);
				feedbackContent.innerHTML += `Seat ${seatNumber} AE세트 삭제 성공\n`;
			})
			.catch((error) => {
				console.error(error)
				feedbackContent.innerHTML += `Seat ${seatNumber} AE세트 삭제 실패\n`;
			});
		}

		// 하위 디바이스 활성화 및 피드백 업데이트
		function toggleSubDevice(seatNumber, subDevice, action) {
			fetch(`/devices/Seat${seatNumber}/${subDevice}?action=${action}`, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
			}).then((response) => {
				if (!response.ok)
				throw new Error(`Failed to turn ${action} ${subDevice}`);

				alert(`Seat ${seatNumber} ${subDevice} is turned ${action}`);
			}).catch((error) => console.error(error));
		}

		// 응급 알림 보내기
		function sendEmergencyAlert() {
			alert("Emergency alert sent!");
		}
    </script>
  </body>
</html>